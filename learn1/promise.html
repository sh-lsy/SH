<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>promise</title>
</head>
<body>
  <script>
    /**
     *  promise 是ES6引入的异步编程的新解决方案  语法上promise是一个构造函数
     *    1.Promise构造函数: Promise(excutor){}
     *    2. Promise.prototype.then方法
     *    3. Promise.prototype.catch方法
     */ 

    //  实例化Promise对象
    const p = new Promise((resolve,reject) => {
      //  模拟后端请求
      setTimeout(()=> {
        let data = '后端返回的数据'
        let err = '数据读取失败'
        if(Math.random() < 0.9) {
          resolve(data)
        } else {
          reject(err)
        }
      }, 1000)
    })

    //  调用
    p.then(res => {
      console.log('test',res)
    }).catch(err => {
      console.error('test', err)
    })


    // https://api.apiopen.top/getJoke
    // fetch 请求  自带promise
    fetch('https://api.apiopen.top/getJoke')
      .then(response => response.json())
      .then(data => {
        console.log('test',data)
      })
      .catch( err => {
        console.log('test',err)
      })

    // ajax 请求 promise封装

    const request = new Promise((resolve, reject) => {
      //  创建对象
      const xhr = new XMLHttpRequest()
      //  初始化
      xhr.open('get', 'https://api.apiopen.top/getJoke')
      //  发送
      xhr.send()
      //  绑定事件,处理响应结果
        xhr.onreadystatechange = () => {
          //  状态码200 - 299 表示成功
          if(xhr.readyState === 4) {
            if(xhr.status >=200 && xhr.status < 300) {
              resolve(xhr.response)
            } else {
              reject(xhr.status)
            }
          }
        }
    })
    request.then(res => {
      console.log('ajax',res)
    }).catch(err => {
      console.log('ajax',err)
    })

    /**
     *  Promise.prototype.then
     *  then 方法返回的结果是Promise 对象, 对象状态由回调函数的执行结果决定
     *    1. 如果回调函数中返回结果是非Promise类型的属性,状态为成功,返回值为对象的成功的值
     */
    const pThen = new Promise((resolve, reject) => {
      setTimeout(() => {
        resolve('数据')
        // reject('错误...')
      }, 1000)
    })
    const result = pThen.then(res => {
      console.log('Promise.prototype.then',res)
      //  非promise
      // return '1111'
      //  promise对象
      return new Promise((resolve, reject) => {
        // resolve('ok')
        // err 被catch捕获 则PromiseResult 为undefined
        reject('error')
      })
    }).catch(err => {
      console.log('test',err)
    })
    console.log('Promise.prototype.then', result)
  </script>
</body>
</html>